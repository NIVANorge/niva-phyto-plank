---
title: "NIVAgis"
output: html_notebook
---

The purpose of this notebook is to demonstrate how to connect to NIVA's GeoServer and query Miljødirektoratet's vannforekomster.
Within this we can get vanntype and other information about the waterbody.

It is also useful for creating maps.


## Loading libraries and connect WFS

Connecting to <https://geoserver.p.niva.no/>

```{r}
library(ows4R)
library(rstudioapi)
library(dplyr)
wfs <- WFSClient$new("https://geoserver.p.niva.no/wfs", 
                     serviceVersion = "2.0.0", 
                     user = askForPassword("NIVA username"), 
                     pwd = askForPassword("NIVA password"))
types <- wfs$getFeatureTypes()
names <- sapply(types, function(ft) ft$getName())
print(names)

```

## Query miljodir_innsjovannforekomster_f in vannområde "Horten - Larvik"


```{r}
innsjoType <- Filter(function(ft) ft$getName() == "no.niva:miljodir_innsjovannforekomster_f", types)[[1]]
innsjoFields <- sapply(innsjoType$getDescription(), function(fi) fi$getName())
print(innsjoFields)
innsjoFeatures <- innsjoType$getFeatures(filter = OGCFilter$new(PropertyIsEqualTo$new("vannomrade", "Horten - Larvik")))
innsjoer <- innsjoFeatures %>% select(vannforekomstid,vannforekomstnavn,vanntype)
print(innsjoer)
```

## Create a map using leaflet

```{r}
library(leaflet)
library(sf)

leaflet(st_transform(innsjoer, crs = 4326)) %>%
  addTiles(urlTemplate = "https://cache.kartverket.no/v1/wmts/1.0.0/topo/default/webmercator/{z}/{y}/{x}.png",
           attribution = "Kartverket") %>%
  addPolygons()
```

## Query AquaMonitor stations in these lakes

```{r}


```

